# process_definition_import_tool
Dolphinscheduler 外部作业导入工具(2.0)

 - [用途](#用途)
 - [代码概述](#代码概述)
 - [特性](#特性)
 - [生成过程](#生成过程)


---

## 用途
将通用的外部定义的作业配置导入到 Dolphinscheduler 指定的项目中, 目前支持版本2.0, 主要适用于作业迁移和开发/测试与生产隔离的情况.

  * 由于2.0使用了特定code作为实际id的机制, 无法像1.3.6一样直接操作数据库, 当前版本通过调用DS的`API`实现项目的导入
  
  ** dependent任务和sub_process任务的参数中,指向其他作业的code在导入时无法自动映射, 在生成dependent任务和sub_process任务时, 引用的流程必须已经存在 **
  
  ** 因为数仓任务涉及业务连续性问题, 不允许跨日执行, 大部分作业节点必须有前一天的任务自依赖, 但迁移后首次执行时不能有依赖节点, 否则会等待不存在的任务实例(空跑仍然会等待依赖节点) **

  * 以上问题有三种解决办法:
  1. 生成两次任务, 第一次生成时不生成依赖节点, 全部空跑一次, 再在保留原任务code的基础上全部更新一次作业定义
  2. 作业一次性生成, 通过api禁用所有依赖节点, 全部空跑一次后再启用依赖节点(但是目前 'api:releaseTaskDefinition' 对流程中的任务定义不生效 2.0.2-release)
  3. 第一次生成时依赖节点状态为失效, shell命令替换为echo, 全部跑一次, 再将流程定义全部更新一次(使用此方式)

  
  * 同时更新作业定义时, 已存在的作业定义必须保留, 否则自依赖引用会失效, 使用以下流程实现完全增量更新:
  1. 用名称匹配项目下已有的流程code, 不存在时建立空流程; 删除未匹配到的旧流程.
  2. 用名称匹配项目下已有的任务code, 不存在时生成新任务code, 必须保证 '流程名称,任务名称,任务类型' 唯一
  3. 遍历dag生成流程, 将流程定义更新到服务中


## 代码概述

* `general_scripts.py`
  通用配置定义, 该配置主要适用于金融类数仓的分组.
  * `etl_jobs`
    基础作业任务, 前几个关键元素分别是 **分组**, **主题**, **作业名**, **执行周期**, **周期偏移量**
  * `etl_dependencies`
    基础作业间的依赖关系, 元素分别是 **分组**, **主题**, **作业名**, **依赖的分组**, **依赖的主题**, **依赖的作业名**

* `ds_config.py`
  DS服务的口令及地址

* `utils.main_general.py`
  将general_scripts.py的定义转化为`dag_node.py`中的`DAGNode`对象, 生成`processDefinition`的数据, 通过api更新到服务中。
  * `SELF_DEPENDENT_CYCLE_MAPPINGS` 定义作业定义中 **执行周期**+**周期偏移量** 与 **DS自依赖周期**,**DS自依赖日期**,**DS周期组** 的关系(用于自动生成数仓任务中的自依赖节点)
  * `SELF_DEPENDENT_GROUPS` 定义哪些**分组**中的任务需要添加**自依赖**节点
  * `PROCESS_RELATIONS` 定义如何对`general_scripts.py`中的作业进行**多层分组**
    * 多层分组后,会通过**子流程**的方式关联
    * 元素为: **分组key** : \[**上级分组key**,**上级分组流程名称**,**上级分组流程描述**\],(生成时根据**上级分组key**循环生成上级分组,直至没有上级分组)


## 特性

** 由于数仓作业种类多且杂且`DS目前不支持项目级的作业操作`, 每个作业一个流程会导致任务数巨大且触发配置困难, 上万个有复杂依赖关系的任务只能分层切分至多个流程组, 通过子流程完成整体任务的触发 **
* `utils.main_general.py`.`SELF_DEPENDENT_CYCLE_MAPPINGS` 目前通过 **分组**,**主题**,**周期** 来生成对应的分组
* **3级以下** 分组的 **任务的依赖** 会上升为同级别(3级以下)中 **子任务间的DAG依赖**, **3级以下** 分组找不到共同分组时, 自动添加任务的 **依赖节点**


## 生成过程(新)

1. DS中添加 **租户**, **用户** 和 **项目**
2. 配置`ds_config.py`
3. 生成`general_scripts.py`
4. 对照`general_scripts.py`, 匹配`main_general.py`中的`SELF_DEPENDENT_CYCLE_MAPPINGS`,`SELF_DEPENDENT_GROUPS`,`PROCESS_RELATIONS`
5. 执行`python/python3 ds_tool.py --project_name [项目名称] --tenant_name [租户名称]`